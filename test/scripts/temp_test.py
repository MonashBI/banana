import os
from tempfile import NamedTemporaryFile as TempFile
from arcana.data import Fileset
from banana.analysis.mri import DwiAnalysis

bval_contents = "0 999.9990675 999.1957878 999.847349 999.9184279 1000.528849 999.3325408 1000.460819 1000.663403 1000.82423 998.9585154 1000.235718 999.8659056 1000.209116 0 1000.892814 999.4976777 1000.600914 1000.480572 1000.871303 999.3459327 1001.072456 1000.802222 1000.468465 1000.092371 998.6869135 999.2041927 1001.098043 0 999.5482856 1000.157935 1000.290862 999.6422178 1000.514219 1000.332847 3000.012278 2999.993165 2999.980226 3000.014548 2999.989669 2999.98404 3000.005654 0 2999.996167 2999.996289 3000.005738 3000.017908 3000.018186 3000.002416 2999.996743 2999.995576 2999.982697 3000.002211 3000.012612 3000.00375 3000.007988 0 3000.003573 3000.017674 2999.986429 2999.988599 3000.008441 2999.993909 3000.012023 3000.011704 3000.014653 3000.014632 3000.007377 3000.009169 3000.01036 0 3000.003336 2999.991081 2999.992556 2999.99496 2999.993143 3000.014428 2999.991642 3000.01428 2999.986016 2999.999841 2999.983552 3000.001972 2999.991808 0 3000.018691 2999.997693 3000.002912 2999.999998 2999.981727 3000.003897 2999.997707 2999.991735 2999.988062 2999.988173 2999.993728 2999.989211 3000.004515 0 2999.98266 2999.998499 2999.982056 3000.006695 3000.0017"
bvec_contents = """0 -0.0736161724945376 -0.164357102118548 -0.822499956717416 -0.0014314531438441 0.579449875664274 0.517997687429983 -0.787723698484948 0.132923247474104 0.0912178475821894 0.169891887381279 -0.119456360882525 -0.375525937096527 0.318396338055388 0 -0.84736605129976 0.933994555238604 0.119310878365237 0.768154028258085 -0.986546044241631 -0.932031742308084 0.6496466201393 -0.369005821802902 0.55689074870536 0.0676807889902975 0.399515381607815 -0.522608774847048 0.286089343702601 0 -0.655668945195158 -0.163810676276751 0.940229899689773 0.49653769374086 -0.578102936998546 0.478740712986574 0.541085351753038 -0.528046981829249 0.761248458526312 -0.742141818418983 -0.514713785792836 -0.668120767077517 -0.148543608546038 0 -0.141668398538754 0.835628861175459 -0.333890157089454 0.453751219528447 -0.659578150863018 -0.0631570176441757 0.999349379872803 0.629175286206645 0.736554147207164 0.198247025201883 0.256264064030404 0.0438657386147214 0.202260213970888 0 0.941540852293397 -0.617943340866389 -0.658545428741935 -0.974856919375847 -0.218285300230765 0.223948793397813 0.35604947920104 -0.693961443928333 0.752690166007301 -0.870238738918582 0.926514707502671 -0.367287809363616 -0.47118357607428 0 0.0749355466713018 0.238130840712347 -0.962373687381714 -0.291569103921123 0.624099205490161 0.41332673150495 0.900829767608298 0.808020635578857 -0.836438172013459 -0.704909916579237 -0.880801474417025 0.00903993109158216 -0.331200471452336 0 0.765153527246783 0.438497875979296 -0.471101818213164 -0.24525543799476 -0.684237151135938 -0.6015031678235 0.0514268746953398 -0.354578784223574 0.479290158257059 0.443201174718167 0.248734348623243 -0.288391695557992 -0.902014057305303 0 0.755495484999602 -0.290359603824644 0.538834007554478 0.225816963728057 -0.0977092733173972
-0 0.992459095764125 -0.366658861425008 -0.0188761134973541 0.260061348566634 -0.571453574747402 0.767534329955175 -0.364600361488783 -0.072883230306685 0.550366609411265 0.623828352275337 0.301482962707263 0.897996716091475 0.301510849643028 -0 -0.199845238445247 0.34300221239545 0.85733753663567 -0.0735032808910214 0.15955439121966 0.211262661238917 -0.74486777993937 0.919456999284581 -0.335017714389414 -0.0195001183192064 -0.378131396536582 -0.761601583467503 0.275015400889522 -0 0.754949214198037 -0.849188577565925 0.239425529345117 0.77822800176854 -0.202936131185333 -0.0500938133998195 -0.721933597216657 -0.264096538173844 0.624223532553304 0.389164256431581 -0.561567532002381 -0.666932382408132 0.589432081530504 -0 -0.679596471072064 0.059500892580874 0.292123729421659 -0.8807427578805 0.657881005110844 0.949878649871932 -0.0045717333059783 0.234305056629806 0.463645850633873 -0.342828012208174 -0.956877068255485 -0.885493669375345 -0.855760513111787 -0 -0.155911800199635 0.694111386188409 -0.492000730587419 -0.170463306904922 0.827430174020568 0.811997822976576 -0.609009151475924 0.401774734701943 -0.444603360545505 0.445568217017676 -0.205537273318082 0.545976924276189 0.573443347009305 -0 -0.98017927997613 0.95095407732011 -0.140106425673273 -0.386571026205595 0.234342146550071 -0.815263995232148 0.160435103685747 -0.485058745037236 -0.485702558523726 0.0313814817501277 -0.457912299498498 -0.65139590094542 -0.826289182934573 -0 -0.623867422392632 -0.0404895308262642 0.233598287823585 -0.0548738020231729 -0.72654850229537 0.152218141313318 -0.403054737146647 -0.60816068633251 0.579858187146662 0.55597988212727 0.953108508394957 -0.939942395676833 0.146661836295624 -0 0.446190864192157 -0.0428361098914066 0.842262714945825 -0.673876611040452 0.757950196398895
0 0.0980081803722674 -0.915722677135374 0.568451856982256 0.965591034131755 0.58110124190105 -0.377583696843298 0.496546021033483 0.988442939902698 -0.829925237707957 0.762872816326663 -0.945958878760645 0.229308023420671 0.898729648017935 0 -0.491968145287185 -0.10001826699375 0.500736719504529 -0.636031961601035 -0.0356272240350672 0.294423026997484 0.152089644564291 -0.135770135285811 -0.760023569343458 -0.997516444154557 0.835107243117038 -0.38320111754315 -0.917888564820176 0 -0.0122441360742221 -0.502040658742326 0.242163483019117 0.38446260662365 0.790325199187035 0.876526062872184 -0.431321832186759 -0.807105571590306 -0.175629627787295 0.54568919978879 0.647851545685858 0.329872458683469 0.794043208544156 0 0.719776841205959 0.546062313172833 0.896203709814423 -0.135654063588916 -0.363523378284939 -0.306172730336677 -0.0357759186287698 -0.741107009470276 -0.492463717917144 -0.918241292287269 0.136802800698939 0.462576220236877 -0.47619822501299 0 0.298650856061749 0.369263334950257 -0.569432349078312 -0.14351392930505 0.517407803361076 -0.538986524305342 -0.708757096614499 -0.597490232782819 -0.485577352708611 -0.21012734554728 -0.315158574564012 -0.752999909793406 0.670185620588274 0 -0.183393681862409 0.197433647916405 0.232824129543982 0.874957312156239 0.745375033703712 0.405592938644646 -0.403443066047987 0.334395971874596 -0.253898028759322 -0.708602295487483 0.120437074559671 -0.758684163878605 0.455579228738881 0 -0.159152506387317 -0.89781969885256 -0.850585044077472 0.96790424907442 -0.0628235227038882 0.784234389296682 0.913729804929958 -0.710221419663208 0.658821241658422 -0.703177850290832 -0.17238154184346 -0.182588397063713 -0.406030721288195 0 0.479729386961013 -0.955958350701425 0.015856574525985 0.703489169513504 -0.644953020276642"""


with TempFile('w', delete=False) as bvalf, TempFile('w', delete=False) as bvecf:
    bvalf.write(bval_contents)
    bvecf.write(bvec_contents)
try:
    bvals = Fileset.from_path(bvalf.name)
    bvecs = Fileset.from_path(bvecf.name)

    mock = DwiAnalysis.mock(inputs=['series', 'reverse_phase',
                                    ('bvalues', bvals), ('grad_dirs', bvecs)],
                            switches={'response_algorithm': 'dhollander'})

    stack = mock.pipeline_stack('tensor_residual')
finally:
    os.remove(bvalf.name)
    os.remove(bvecf.name)
